# æ•°æ®åº“ä½“ç³»æ¶æ„è¯´æ˜

## ğŸ“Š æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Auth (ç³»ç»Ÿè‡ªå¸¦)                  â”‚
â”‚                    auth.users                                â”‚
â”‚                    (ç”¨æˆ·ç™»å½•è®¤è¯)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ 1:1 å…³è”
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒè¡¨ï¼šusers                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ id (å…³è” auth.users)                              â”‚    â”‚
â”‚  â”‚ â€¢ email, full_name                                  â”‚    â”‚
â”‚  â”‚ â€¢ credits_balance (å½“å‰å¯ç”¨ç§¯åˆ†) â­                  â”‚    â”‚
â”‚  â”‚ â€¢ credits_total (ç´¯è®¡è·å¾—ç§¯åˆ†)                       â”‚    â”‚
â”‚  â”‚ â€¢ credits_spent (ç´¯è®¡æ¶ˆè´¹ç§¯åˆ†)                       â”‚    â”‚
â”‚  â”‚ â€¢ subscription_plan (è®¢é˜…è®¡åˆ’)                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚              â”‚
        â–¼            â–¼            â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢é˜…è¡¨    â”‚ â”‚ ç§¯åˆ†äº¤æ˜“  â”‚ â”‚ è§†é¢‘ä»»åŠ¡  â”‚ â”‚ æ”¯ä»˜è®°å½•  â”‚
â”‚user_      â”‚ â”‚credit_    â”‚ â”‚video_jobs â”‚ â”‚payments   â”‚
â”‚subscriptionsâ”‚â”‚transactionsâ”‚â”‚           â”‚ â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¸‰å¤§æ ¸å¿ƒæ¨¡å—

### 1ï¸âƒ£ ç”¨æˆ·ä¸è®¤è¯æ¨¡å—

**æ ¸å¿ƒè¡¨ï¼š`users`**

```sql
users è¡¨
â”œâ”€â”€ id (UUID, å…³è” auth.users) â† è¿™æ˜¯å…³é”®ï¼å…³è” Supabase è®¤è¯ç³»ç»Ÿ
â”œâ”€â”€ email, full_name (ç”¨æˆ·ä¿¡æ¯)
â”œâ”€â”€ subscription_plan (è®¢é˜…è®¡åˆ’: free/basic/creator/pro)
â”œâ”€â”€ subscription_status (è®¢é˜…çŠ¶æ€: active/canceled)
â””â”€â”€ credits_balance, credits_total, credits_spent (ç§¯åˆ†ç³»ç»Ÿæ ¸å¿ƒ)
```

**ä½œç”¨**ï¼š
- å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆé‚®ç®±ã€å§“åï¼‰
- å­˜å‚¨ç§¯åˆ†ä¿¡æ¯ï¼ˆä½™é¢ã€ç´¯è®¡ã€æ¶ˆè´¹ï¼‰
- å­˜å‚¨è®¢é˜…ä¿¡æ¯ï¼ˆè®¡åˆ’ã€çŠ¶æ€ï¼‰

**å…³ç³»**ï¼š
- `users.id` â† â†’ `auth.users.id` (1:1ï¼Œæ¯ä¸ªç™»å½•ç”¨æˆ·å¯¹åº”ä¸€ä¸ª users è®°å½•)

---

### 2ï¸âƒ£ ç§¯åˆ†ç³»ç»Ÿæ¨¡å—

**æ ¸å¿ƒè¡¨ï¼š`credit_transactions`**

```sql
credit_transactions è¡¨
â”œâ”€â”€ user_id (å…³è” users)
â”œâ”€â”€ amount (æ­£æ•°=å¢åŠ ï¼Œè´Ÿæ•°=æ‰£é™¤)
â”œâ”€â”€ transaction_type (credit/debit/refund)
â”œâ”€â”€ reason (purchase/subscription/refund/manual/generation)
â””â”€â”€ metadata (JSONï¼Œé¢å¤–ä¿¡æ¯)
```

**ä½œç”¨**ï¼š
- è®°å½•æ¯ä¸€æ¬¡ç§¯åˆ†å˜åŠ¨ï¼ˆå¢åŠ /æ‰£é™¤/é€€æ¬¾ï¼‰
- ç”¨äºå®¡è®¡å’Œè°ƒè¯•
- å¯ä»¥è¿½è¸ªç§¯åˆ†æ¥æºå’Œå»å‘

**æ•°æ®æµ**ï¼š
```
ç”¨æˆ·è´­ä¹°è®¢é˜…
    â†“
æ”¯ä»˜æˆåŠŸ (payments è¡¨è®°å½•)
    â†“
è°ƒç”¨ credit_user_credits_transaction() å‡½æ•°
    â†“
æ›´æ–° users.credits_balance (+100)
    â†“
è®°å½•åˆ° credit_transactions (è®°å½•è¿™ç¬”äº¤æ˜“)
```

**å…³é”®å‡½æ•°**ï¼š
- `credit_user_credits_transaction()` - å¢åŠ ç§¯åˆ†ï¼ˆåŸå­æ“ä½œï¼‰
- `debit_user_credits_transaction()` - æ‰£é™¤ç§¯åˆ†ï¼ˆåŸå­æ“ä½œï¼‰
- `refund_user_credits()` - é€€è¿˜ç§¯åˆ†ï¼ˆåŸå­æ“ä½œï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦å‡½æ•°ï¼Ÿ**
- ä¿è¯åŸå­æ€§ï¼šç§¯åˆ†æ›´æ–° + è®°å½•äº¤æ˜“æ˜¯åŸå­æ“ä½œï¼ˆè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼‰
- é˜²æ­¢å¹¶å‘é—®é¢˜ï¼šä¸¤ä¸ªè¯·æ±‚åŒæ—¶æ‰£é™¤ç§¯åˆ†æ—¶ä¸ä¼šå‡ºé”™
- æ•°æ®ä¸€è‡´æ€§ï¼š`users.credits_balance` å’Œ `credit_transactions` å§‹ç»ˆä¸€è‡´

---

### 3ï¸âƒ£ è§†é¢‘ç”Ÿæˆæ¨¡å—

**æ ¸å¿ƒè¡¨ï¼š`video_jobs`**

```sql
video_jobs è¡¨
â”œâ”€â”€ user_id (å…³è” users)
â”œâ”€â”€ job_id (å¤–éƒ¨ç³»ç»Ÿè¿”å›çš„ä»»åŠ¡IDï¼Œå”¯ä¸€)
â”œâ”€â”€ status (pending/processing/completed/failed)
â”œâ”€â”€ prompt (ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯)
â”œâ”€â”€ image_url (è¾“å…¥å›¾ç‰‡ï¼Œå¦‚æœæ˜¯å›¾ç‰‡ç”Ÿæˆè§†é¢‘)
â”œâ”€â”€ result_url (ç”Ÿæˆçš„è§†é¢‘URL)
â”œâ”€â”€ cost_credits (æ¶ˆè€—çš„ç§¯åˆ†)
â””â”€â”€ model (ä½¿ç”¨çš„æ¨¡å‹: veo3/sora2ç­‰)
```

**æ•°æ®æµ**ï¼š
```
ç”¨æˆ·å‘èµ·ç”Ÿæˆè¯·æ±‚
    â†“
æ£€æŸ¥ users.credits_balance æ˜¯å¦è¶³å¤Ÿ
    â†“
è°ƒç”¨ debit_user_credits_transaction() æ‰£é™¤ç§¯åˆ†
    â†“
åˆ›å»º video_jobs è®°å½• (status='pending')
    â†“
è°ƒç”¨å¤–éƒ¨ API ç”Ÿæˆè§†é¢‘
    â†“
æ›´æ–° video_jobs (status='processing' â†’ 'completed')
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è´­ä¹°è®¢é˜…å¹¶ç”Ÿæˆè§†é¢‘

```
1. ç”¨æˆ·æ³¨å†Œ
   â””â”€> auth.users åˆ›å»º (Supabase Auth)
   â””â”€> users è¡¨è‡ªåŠ¨åˆ›å»ºè®°å½• (è§¦å‘å™¨ handle_new_user)
   â””â”€> åˆå§‹ç§¯åˆ†: credits_balance = 3

2. ç”¨æˆ·è´­ä¹°è®¢é˜…
   â””â”€> æ”¯ä»˜æˆåŠŸ (Creem æ”¯ä»˜ç³»ç»Ÿ)
   â””â”€> webhook æ”¶åˆ°æ”¯ä»˜æˆåŠŸé€šçŸ¥
   â””â”€> payments è¡¨è®°å½•æ”¯ä»˜ä¿¡æ¯
   â””â”€> user_subscriptions è¡¨åˆ›å»ºè®¢é˜…è®°å½•
   â””â”€> è°ƒç”¨ credit_user_credits_transaction() å¢åŠ ç§¯åˆ†
   â””â”€> users.credits_balance += 100
   â””â”€> credit_transactions è®°å½•: +100, reason='subscription'

3. ç”¨æˆ·ç”Ÿæˆè§†é¢‘
   â””â”€> æ£€æŸ¥ users.credits_balance >= 20
   â””â”€> è°ƒç”¨ debit_user_credits_transaction() æ‰£é™¤ç§¯åˆ†
   â””â”€> users.credits_balance -= 20
   â””â”€> credit_transactions è®°å½•: -20, reason='generation'
   â””â”€> video_jobs åˆ›å»ºè®°å½• (status='pending')
   â””â”€> è°ƒç”¨å¤–éƒ¨ API ç”Ÿæˆè§†é¢‘
   â””â”€> æ›´æ–° video_jobs (status='completed', result_url='...')
```

---

## ğŸ“‹ æ‰€æœ‰è¡¨çš„åŠŸèƒ½è¯´æ˜

### æ ¸å¿ƒè¡¨ï¼ˆå¿…é¡»ï¼‰

| è¡¨å | ä½œç”¨ | å…³é”®å­—æ®µ |
|------|------|----------|
| `users` | ç”¨æˆ·ä¿¡æ¯å’Œç§¯åˆ† | `credits_balance`, `credits_total`, `credits_spent` |
| `credit_transactions` | ç§¯åˆ†äº¤æ˜“è®°å½• | `amount`, `transaction_type`, `reason` |
| `video_jobs` | è§†é¢‘ç”Ÿæˆä»»åŠ¡ | `job_id`, `status`, `cost_credits` |
| `payments` | æ”¯ä»˜è®°å½• | `payment_id`, `amount`, `status` |
| `user_subscriptions` | è®¢é˜…ä¿¡æ¯ | `plan_type`, `plan_status`, `subscription_id` |

### è¾…åŠ©è¡¨ï¼ˆå¯é€‰ï¼‰

| è¡¨å | ä½œç”¨ |
|------|------|
| `api_keys` | API å¯†é’¥ç®¡ç† |
| `usage_stats` | ä½¿ç”¨ç»Ÿè®¡ï¼ˆæ¯æ—¥ï¼‰ |
| `user_email_aliases` | é‚®ç®±åˆ«åï¼ˆç”¨äºæ”¯ä»˜åŒ¹é…ï¼‰ |
| `unmatched_payment_emails` | æœªåŒ¹é…çš„æ”¯ä»˜é‚®ç®±ï¼ˆå¤„ç†å¼‚å¸¸ï¼‰ |
| `system_config` | ç³»ç»Ÿé…ç½®ï¼ˆç§¯åˆ†ä»·æ ¼ç­‰ï¼‰ |

---

## ğŸ”— è¡¨ä¹‹é—´çš„å…³ç³»

```
auth.users (Supabase ç³»ç»Ÿè¡¨)
    â†“ 1:1
users (ä½ çš„ç”¨æˆ·è¡¨)
    â†“ 1:N
    â”œâ”€â”€ user_subscriptions (ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…å†å²)
    â”œâ”€â”€ credit_transactions (ä¸€ä¸ªç”¨æˆ·æœ‰å¤šç¬”ç§¯åˆ†äº¤æ˜“)
    â”œâ”€â”€ video_jobs (ä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªè§†é¢‘ç”Ÿæˆä»»åŠ¡)
    â”œâ”€â”€ payments (ä¸€ä¸ªç”¨æˆ·æœ‰å¤šæ¬¡æ”¯ä»˜)
    â””â”€â”€ api_keys (ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ª API å¯†é’¥)
```

---

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶ï¼šRLS (Row Level Security)

**RLS æ˜¯ä»€ä¹ˆï¼Ÿ**
- è¡Œçº§å®‰å…¨ç­–ç•¥
- ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

**ç¤ºä¾‹**ï¼š
```sql
-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç§¯åˆ†äº¤æ˜“
CREATE POLICY "Users can view own transactions" ON credit_transactions
  FOR SELECT USING (auth.uid() = user_id);
```

**æ•ˆæœ**ï¼š
- ç”¨æˆ· A åªèƒ½çœ‹åˆ°è‡ªå·±çš„ `credit_transactions`
- ç”¨æˆ· A æ— æ³•çœ‹åˆ°ç”¨æˆ· B çš„æ•°æ®
- å³ä½¿ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œä¹Ÿå— RLS é™åˆ¶

---

## ğŸ”§ å…³é”®å‡½æ•°è¯´æ˜

### ç§¯åˆ†å‡½æ•°ï¼ˆåŸå­æ“ä½œï¼‰

```sql
-- å¢åŠ ç§¯åˆ†
credit_user_credits_transaction(
  user_id,      -- ç”¨æˆ·ID
  amount,        -- ç§¯åˆ†æ•°é‡ï¼ˆæ­£æ•°ï¼‰
  reason,        -- åŸå› ï¼ˆ'subscription'/'purchase'ç­‰ï¼‰
  metadata       -- é¢å¤–ä¿¡æ¯ï¼ˆJSONï¼‰
)
â†’ è¿”å›: { credits_balance, credits_total, credits_spent }

-- æ‰£é™¤ç§¯åˆ†
debit_user_credits_transaction(
  user_id,
  amount,        -- ç§¯åˆ†æ•°é‡ï¼ˆæ­£æ•°ï¼‰
  reason,        -- åŸå› ï¼ˆ'generation'ç­‰ï¼‰
  metadata
)
â†’ è¿”å›: { credits_balance, credits_total, credits_spent }

-- é€€è¿˜ç§¯åˆ†
refund_user_credits(
  user_id,
  amount,
  reason,
  metadata
)
â†’ è¿”å›: { credits_balance, credits_total, credits_spent }
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å‡½æ•°ï¼Ÿ**
1. **åŸå­æ€§**ï¼šæ›´æ–° `users` è¡¨ + æ’å…¥ `credit_transactions` è¡¨æ˜¯åŸå­æ“ä½œ
2. **å¹¶å‘å®‰å…¨**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶æ“ä½œæ—¶ä¸ä¼šå‡ºé”™
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯ `users.credits_balance` å’Œ `credit_transactions` å§‹ç»ˆä¸€è‡´

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### ç§¯åˆ†å¢åŠ æµç¨‹

```
1. ä»£ç è°ƒç”¨: credit_user_credits_transaction(user_id, 100, 'subscription')
   â†“
2. å‡½æ•°å†…éƒ¨:
   â”œâ”€ æŸ¥è¯¢ users.credits_balance (å½“å‰å€¼)
   â”œâ”€ æ£€æŸ¥: å½“å‰å€¼ + 100 <= 50000 (ä¸Šé™æ£€æŸ¥)
   â”œâ”€ æ›´æ–°: users.credits_balance += 100
   â”œâ”€ æ›´æ–°: users.credits_total += 100
   â”œâ”€ æ’å…¥: credit_transactions (è®°å½•è¿™ç¬”äº¤æ˜“)
   â””â”€ è¿”å›: æ–°çš„ç§¯åˆ†å€¼
   â†“
3. è¿”å›ç»“æœ: { credits_balance: 103, credits_total: 103, credits_spent: 0 }
```

### ç§¯åˆ†æ‰£é™¤æµç¨‹

```
1. ä»£ç è°ƒç”¨: debit_user_credits_transaction(user_id, 20, 'generation')
   â†“
2. å‡½æ•°å†…éƒ¨:
   â”œâ”€ æŸ¥è¯¢ users.credits_balance (å½“å‰å€¼)
   â”œâ”€ æ£€æŸ¥: å½“å‰å€¼ >= 20 (ä½™é¢æ£€æŸ¥)
   â”œâ”€ æ›´æ–°: users.credits_balance -= 20
   â”œâ”€ æ›´æ–°: users.credits_spent += 20
   â”œâ”€ æ’å…¥: credit_transactions (è®°å½•è¿™ç¬”äº¤æ˜“)
   â””â”€ è¿”å›: æ–°çš„ç§¯åˆ†å€¼
   â†“
3. è¿”å›ç»“æœ: { credits_balance: 83, credits_total: 103, credits_spent: 20 }
```

---

## ğŸ¯ å…³é”®æ¦‚å¿µæ€»ç»“

### 1. ä¸ºä»€ä¹ˆ `users` è¡¨è¦å…³è” `auth.users`ï¼Ÿ

- `auth.users` æ˜¯ Supabase çš„è®¤è¯è¡¨ï¼ˆç³»ç»Ÿç®¡ç†ï¼‰
- `users` æ˜¯ä½ çš„ä¸šåŠ¡è¡¨ï¼ˆå­˜å‚¨ç§¯åˆ†ã€è®¢é˜…ç­‰ä¿¡æ¯ï¼‰
- é€šè¿‡ `users.id = auth.users.id` å…³è”ï¼Œå®ç°ï¼š
  - ç™»å½•åè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·
  - RLS ç­–ç•¥è‡ªåŠ¨ç”Ÿæ•ˆï¼ˆ`auth.uid()` å¯ä»¥è·å–å½“å‰ç”¨æˆ·ï¼‰

### 2. ä¸ºä»€ä¹ˆéœ€è¦ `credit_transactions` è¡¨ï¼Ÿ

- å®¡è®¡ï¼šè®°å½•æ¯æ¬¡ç§¯åˆ†å˜åŠ¨
- è°ƒè¯•ï¼šå‡ºé—®é¢˜æ—¶å¯ä»¥è¿½è¸ª
- é€€æ¬¾ï¼šå¯ä»¥è¿½æº¯åŸå§‹äº¤æ˜“
- ç»Ÿè®¡ï¼šå¯ä»¥åˆ†æç§¯åˆ†ä½¿ç”¨æƒ…å†µ

### 3. ä¸ºä»€ä¹ˆç§¯åˆ†æ“ä½œè¦ç”¨å‡½æ•°è€Œä¸æ˜¯ç›´æ¥ SQLï¼Ÿ

**ç›´æ¥ SQL çš„é—®é¢˜**ï¼š
```sql
-- è¿™æ ·ä¸å®‰å…¨ï¼
UPDATE users SET credits_balance = credits_balance - 20 WHERE id = 'xxx';
INSERT INTO credit_transactions ...;
-- å¦‚æœ INSERT å¤±è´¥ï¼ŒUPDATE å·²ç»æ‰§è¡Œäº†ï¼Œæ•°æ®ä¸ä¸€è‡´ï¼
```

**å‡½æ•°çš„å¥½å¤„**ï¼š
```sql
-- å‡½æ•°å†…éƒ¨æ˜¯åŸå­æ“ä½œ
debit_user_credits_transaction(...);
-- å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå›æ»šï¼Œæ•°æ®ä¸€è‡´ï¼
```

### 4. è¡¨ä¹‹é—´çš„å…³ç³»

- **users** â† 1:1 â†’ **auth.users** (è®¤è¯å…³è”)
- **users** â† 1:N â†’ **credit_transactions** (ä¸€ä¸ªç”¨æˆ·å¤šç¬”äº¤æ˜“)
- **users** â† 1:N â†’ **video_jobs** (ä¸€ä¸ªç”¨æˆ·å¤šä¸ªè§†é¢‘)
- **users** â† 1:N â†’ **payments** (ä¸€ä¸ªç”¨æˆ·å¤šæ¬¡æ”¯ä»˜)
- **users** â† 1:1 â†’ **user_subscriptions** (ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªè®¢é˜…)

---

## âœ… æ£€æŸ¥æ¸…å•

### æ•°æ®åº“æ˜¯å¦å®Œæ•´ï¼Ÿ

1. âœ… `users` è¡¨å­˜åœ¨ä¸”å…³è” `auth.users`
2. âœ… `credit_transactions` è¡¨å­˜åœ¨
3. âœ… `video_jobs` è¡¨å­˜åœ¨
4. âœ… `payments` è¡¨å­˜åœ¨
5. âœ… `user_subscriptions` è¡¨å­˜åœ¨
6. âœ… ç§¯åˆ†å‡½æ•°å·²åˆ›å»ºï¼ˆ`credit_user_credits_transaction`, `debit_user_credits_transaction`, `refund_user_credits`ï¼‰
7. âœ… RLS ç­–ç•¥å·²å¯ç”¨
8. âœ… è§¦å‘å™¨å·²åˆ›å»ºï¼ˆè‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•ï¼‰

---

## ğŸ” å¸¸è§é—®é¢˜

### Q: `users` è¡¨å’Œ `auth.users` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**: 
- `auth.users`ï¼šSupabase ç³»ç»Ÿè¡¨ï¼Œç®¡ç†ç™»å½•è®¤è¯
- `users`ï¼šä½ çš„ä¸šåŠ¡è¡¨ï¼Œå­˜å‚¨ç§¯åˆ†ã€è®¢é˜…ç­‰ä¸šåŠ¡ä¿¡æ¯
- ä¸¤è€…é€šè¿‡ `id` å­—æ®µå…³è”ï¼ˆ`users.id = auth.users.id`ï¼‰

### Q: ä¸ºä»€ä¹ˆç§¯åˆ†ä¿¡æ¯å­˜åœ¨ `users` è¡¨ï¼Œè¿˜è¦ `credit_transactions` è¡¨ï¼Ÿ

**A**:
- `users.credits_balance`ï¼šå½“å‰ä½™é¢ï¼ˆå¿«ç…§ï¼‰
- `credit_transactions`ï¼šå†å²è®°å½•ï¼ˆæ˜ç»†ï¼‰
- å°±åƒé“¶è¡Œè´¦æˆ·ï¼šä½™é¢æ˜¯å½“å‰å€¼ï¼Œäº¤æ˜“è®°å½•æ˜¯å†å²æ˜ç»†

### Q: å¦‚æœç”¨æˆ·åˆ é™¤è´¦å·ä¼šæ€æ ·ï¼Ÿ

**A**:
- åˆ é™¤ `auth.users` è®°å½•
- ç”±äº `ON DELETE CASCADE`ï¼Œ`users` è¡¨è®°å½•è‡ªåŠ¨åˆ é™¤
- `credit_transactions`, `video_jobs`, `payments` ç­‰å…³è”è®°å½•ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤

---

## ğŸ“ æ€»ç»“

ä½ çš„æ•°æ®åº“ä½“ç³»åˆ†ä¸ºä¸‰å¤§æ¨¡å—ï¼š

1. **ç”¨æˆ·æ¨¡å—** (`users`) - å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œç§¯åˆ†ä½™é¢
2. **ç§¯åˆ†ç³»ç»Ÿ** (`credit_transactions` + å‡½æ•°) - ç®¡ç†ç§¯åˆ†å˜åŠ¨
3. **ä¸šåŠ¡æ¨¡å—** (`video_jobs`, `payments`, `user_subscriptions`) - å­˜å‚¨ä¸šåŠ¡æ•°æ®

æ‰€æœ‰è¡¨éƒ½é€šè¿‡ `user_id` å…³è”åˆ° `users` è¡¨ï¼Œ`users` è¡¨é€šè¿‡ `id` å…³è”åˆ° `auth.users`ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- ç§¯åˆ†æ“ä½œå¿…é¡»é€šè¿‡å‡½æ•°ï¼ˆä¿è¯åŸå­æ€§ï¼‰
- æ‰€æœ‰è¡¨å¯ç”¨ RLSï¼ˆä¿è¯å®‰å…¨ï¼‰
- æ‰€æœ‰å…³è”éƒ½ä½¿ç”¨ `ON DELETE CASCADE`ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰

